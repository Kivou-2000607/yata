{% comment %}
OC2.0 placeholder page
{% endcomment %}
{% load humanize %}

<h2 class="title rounded-top px-2 py-2 rounded mb-3">
    <div class="d-flex flex-wrap align-items-center">
      <div class="px-2 me-auto"><i class="fas fa-fingerprint"></i>&nbsp;OC2.0</div>
    </div>
</h2>
<div class="container-fluid p-md-3 p-1 mb-3">
    {% if error %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endif %}

   

    {% comment %} Debug: Show all groups {% endcomment %}
    <div class="alert alert-info">
        <strong>Debug - Groups found:</strong>
        <ul>
        {% for group in crimes_grouped %}
            <li>{{ group.main_status }}
                <ul>
                {% for subgroup in group.subgroups %}
                    <li>{{ subgroup.sub_status }}: {{ subgroup.crimes|length }} crimes
                        {% if subgroup.sub_status == 'successful' %}
                            <ul>
                            {% for crime in subgroup.crimes %}
                                <li>Crime {{ crime.tID }}: is_unpaid={{ crime.is_unpaid }}, has rewards_parsed={{ crime.rewards_parsed|yesno:"yes,no" }}, rewards={{ crime.rewards }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            </li>
        {% endfor %}
        </ul>
    </div>

    {% for group in crimes_grouped %}
        {% comment %} Calculate total count for main status {% endcomment %}
        {% with total=0 %}
            {% for subgroup in group.subgroups %}
                {% with total=total|add:subgroup.crimes|length %}{% endwith %}
            {% endfor %}
        {% endwith %}

        <h4 class="mt-4 mb-3">
            <a class="text-decoration-none" data-bs-toggle="collapse" href="#collapse{{ group.main_status|slugify }}" role="button" aria-expanded="{% if group.main_status != 'Completed' %}true{% else %}false{% endif %}" aria-controls="collapse{{ group.main_status|slugify }}">
                <i class="fas fa-chevron-down"></i> Status: {{ group.main_status }}
            </a>
        </h4>

        <div class="collapse {% if group.main_status != 'Completed' %}show{% endif %}" id="collapse{{ group.main_status|slugify }}">
        {% for subgroup in group.subgroups %}
            {% if subgroup.sub_status != '_no_substatus' %}
                <h5 class="mt-3 mb-2 ms-3">
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#collapse{{ group.main_status|slugify }}-{{ subgroup.sub_status|slugify }}" role="button" aria-expanded="{% if group.main_status != 'Completed' %}true{% else %}false{% endif %}" aria-controls="collapse{{ group.main_status|slugify }}-{{ subgroup.sub_status|slugify }}">
                        <i class="fas fa-chevron-down"></i> {{ subgroup.sub_status|title }} ({{ subgroup.crimes|length }})
                    </a>
                </h5>
                <div class="collapse {% if group.main_status != 'Completed' %}show{% endif %}" id="collapse{{ group.main_status|slugify }}-{{ subgroup.sub_status|slugify }}">
            {% endif %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Difficulty</th>
                        <th>Previous Crime</th>
                        <th>Created At</th>
                        {% if subgroup.sub_status|lower not in 'planning,recruiting' %}
                            <th>Executed At</th>
                        {% endif %}
                        <th>Ready At</th>
                        {% if subgroup.sub_status|lower == 'successful' %}
                            <th>Rewards</th>
                        {% endif %}
                        <th>Slots</th>
                    </tr>
                </thead>
                <tbody>
                    {% for crime in subgroup.crimes %}
                    <tr {% if crime.has_missing_items or crime.is_unpaid %}class="table-warning"{% endif %}>
                        <td>{{ crime.tID }}</td>
                        <td>{{ crime.name }}</td>
                        <td>{{ crime.difficulty }}</td>
                        <td>{{ crime.previous_crime_id|default:"N/A" }}</td>
                        <td>{{ crime.created_at }}</td>
                        {% if subgroup.sub_status|lower not in 'planning,recruiting' %}
                            <td>{{ crime.executed_at }}</td>
                        {% endif %}
                        <td>{{ crime.ready_at }}</td>
                        {% if subgroup.sub_status|lower == 'successful' %}
                            <td>
                                {% if crime.rewards_parsed %}
                                    <div style="white-space: nowrap;">
                                        {% if crime.is_unpaid %}
                                            <span class="badge bg-warning text-dark mb-1">‚ö†Ô∏è UNPAID</span><br>
                                        {% endif %}
                                        {% if crime.rewards_parsed.money %}üí∞ ${{ crime.rewards_parsed.money|floatformat:0|intcomma }}<br>{% endif %}
                                        {% if crime.rewards_parsed.respect %}‚≠ê {{ crime.rewards_parsed.respect }} respect<br>{% endif %}
                                        {% if crime.rewards_parsed.items %}
                                            {% for item in crime.rewards_parsed.items %}
                                                üì¶ {{ item.name|default:item.id }} x{{ item.quantity }}<br>
                                            {% endfor %}
                                        {% endif %}
                                        {% if crime.rewards_parsed.payout %}
                                            <small class="text-muted">
                                                Paid: {{ crime.rewards_parsed.payout.percentage }}% by {{ crime.rewards_parsed.payout.paid_by_name|default:crime.rewards_parsed.payout.paid_by }}
                                            </small>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <em>No rewards</em>
                                {% endif %}
                            </td>
                        {% endif %}
                        <td>
                            <button type="button" class="btn btn-sm {% if crime.has_missing_items or crime.is_unpaid %}btn-warning{% else %}btn-info{% endif %}" data-bs-toggle="modal" data-bs-target="#slotsModal{{ crime.tID }}">
                                {% if crime.has_missing_items or crime.is_unpaid %}<i class="fas fa-exclamation-triangle"></i> {% endif %}View Slots ({{ crime.slots_parsed|length }})
                            </button>

                            <!-- Slots Modal -->
                                <div class="modal fade" id="slotsModal{{ crime.tID }}" tabindex="-1" aria-labelledby="slotsModalLabel{{ crime.tID }}" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="slotsModalLabel{{ crime.tID }}">
                                                    Crime #{{ crime.tID }} - {{ crime.name }} - Slots
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if crime.slots_parsed %}
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Position</th>
                                                                    <th>User</th>
                                                                    <th>Progress</th>
                                                                    <th>Pass Rate</th>
                                                                    <th>Item</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for slot in crime.slots_parsed %}
                                                                <tr>
                                                                    <td>{{ slot.position }}</td>
                                                                    <td>
                                                                        {% if slot.user %}
                                                                            {{ slot.user.name|default:slot.user.id }}
                                                                        {% else %}
                                                                            <em>Empty</em>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if slot.user %}
                                                                            {{ slot.user.progress }}%
                                                                        {% else %}
                                                                            -
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>{{ slot.checkpoint_pass_rate }}%</td>
                                                                    <td style="white-space: nowrap;">
                                                                        {% if slot.item_requirement %}
                                                                            {% if slot.item_requirement.is_available %}
                                                                                <span class="text-success">‚úì</span>
                                                                            {% else %}
                                                                                <span class="text-danger">‚úó</span>
                                                                            {% endif %}
                                                                            {{ slot.item_requirement.name|default:slot.item_requirement.id }}
                                                                            {% if slot.item_requirement.is_reusable %} ‚ôªÔ∏è{% endif %}
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                {% else %}
                                                    <p><em>No slots</em></p>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if subgroup.sub_status != '_no_substatus' %}
                </div> <!-- End subsection collapse -->
            {% endif %}
        {% endfor %}
        </div> <!-- End main collapse -->
    {% empty %}
        <p class="text-center">No crimes found</p>
    {% endfor %}
</div>
