// ==UserScript==
// @name         YATA - Walls
// @namespace    https://yata.yt/
// @version      1.1
// @icon64       data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMzUuNDcgMTM1LjQ3IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnIHRyYW5zZm9ybT0ibWF0cml4KC45OTkwOSAwIDAgLjk5OTk4IDQuNzk1NmUtNiAtMi4zNTg4ZS03KSI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTE1IDQ2LjE0NCkiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQuMDg4OWUtNiAxLjg1MjEpIj48cmVjdCB4PSItMTE0Ljg4IiB5PSItNDcuOTk2IiB3aWR0aD0iMTM1LjQ3IiBoZWlnaHQ9IjEzNS40NyIgZmlsbD0iI2IzYjNiMyIgc3R5bGU9InBhaW50LW9yZGVyOm5vcm1hbCIvPjxwYXRoIGQ9Im0tMTE0Ljc4LTQ3Ljk5M2gxMzUuMjVzLTEzNC43NSAxMzYuNDYtMTM1LjI1IDEzNS40NmMtMC40OTc3Mi0wLjk5NzAyIDAtMTM1LjQ2IDAtMTM1LjQ2eiIgZmlsbD0iIzQ0N2U5YiIvPjwvZz48L2c+PGcgdHJhbnNmb3JtPSJtYXRyaXgoMS4yMzU0IDAgMCAxLjI0MjYgLTI2LjMyMSAtMjMuMDY4KSI+PHBhdGggdHJhbnNmb3JtPSJtYXRyaXgoMS4wNiAwIDAgMS4wNTM5IC00LjI5ODYgLTYuODEzMikiIGQ9Im0xMjEuMzggNzUuODAzYTQ1LjQ1OSA0NS40NTkgMCAwIDEtNDUuNDU5IDQ1LjQ1OSA0NS40NTkgNDUuNDU5IDAgMCAxLTQ1LjQ1OS00NS40NTkgNDUuNDU5IDQ1LjQ1OSAwIDAgMSA0NS40NTktNDUuNDU5IDQ1LjQ1OSA0NS40NTkgMCAwIDEgNDUuNDU5IDQ1LjQ1OXoiIGZpbGw9IiMzNjM2MzYiIHN0eWxlPSJwYWludC1vcmRlcjptYXJrZXJzIGZpbGwgc3Ryb2tlIi8+PC9nPjxnIHRyYW5zZm9ybT0ibWF0cml4KC45OTI3NCAwIDAgLjk3MzUyIC03LjQxNTIgLTExLjE2NCkiIHN0cm9rZT0iIzM2MzYzNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49ImJldmVsIiBzdHJva2Utd2lkdGg9IjEuNjExOCIgc3R5bGU9InBhaW50LW9yZGVyOm1hcmtlcnMgZmlsbCBzdHJva2UiPjxwYXRoIHRyYW5zZm9ybT0ibWF0cml4KDEuMjM1NCAwIDAgMS4yNDI2IC0xOC4xOTIgLTEzLjE0NykiIGQ9Im03Ni4wNDggNzUuOCAxNS4wOC0zMy4zMDRoMTYuMzI0bC0yMy43OSA0Ny4xMTN2MjYuODA2aC0xNS4xOHYtMjYuODA2bC0yMy43OS00Ny4xMTNoMTYuMzc0eiIgZmlsbD0iI2IzYjNiMyIgc3R5bGU9InBhaW50LW9yZGVyOm1hcmtlcnMgZmlsbCBzdHJva2UiLz48cGF0aCB0cmFuc2Zvcm09Im1hdHJpeCgxLjIzNTQgMCAwIDEuMjQyNiAtMTguMTkyIC0xMy4xNDcpIiBkPSJtNjguNDgzIDg5LjYwOS00LjQxMzQtOC45MjU4YzAuODg0NjYtOC4wMjY0IDEuOTIzOC05LjIxNjggOC40ODk2LTEyLjI4MmwzLjUxODEgNy43NDQzIDQuNzgyMi0xMC4wNTZzNi43NTc2LTIuNTg4IDExLjMzNy04LjQ5MTRjNC4zMzIzLTUuNTg1MyA0LjMyNDktMTUuMzIxIDQuMzI0OS0xNS4zMjFsMTAuOTMxIDAuMjE4NzEtMjMuNzkgNDcuMTEzdjI2LjgwNmgtMTUuMThjMy4zMWUtNCAtOC4wMDQgMC0yNi44MDYgMC0yNi44MDZ6IiBmaWxsPSIjNDQ3ZTliIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPjwvZz48ZyB0cmFuc2Zvcm09Im1hdHJpeCgxLjQwNjggLS4wNTY0NDcgLjA2NDk1OSAxLjMxMDEgLTM5LjM1NyAtMjQuMDY2KSIgZmlsbD0iIzQ0N2U5YiI+PHBhdGggZD0ibTk0Ljk1MiA5NC4yMDQtMi44MDkzIDUuMjU4OCAyLjQwNDggMi42MjM4LTEuNzAzOCAzLjE4OTMtMTEuMzY5LTEzLjMwMSAxLjQ4NDgtMi43Nzk0IDE3LjE3NCAyLjQzMzMtMS43MDM4IDMuMTg5M3ptLTQuNzU3MiAzLjEzMzUgMS45NDQxLTMuNjM5MS02LjMxNjQtMS4xMjA4eiIgc3R5bGU9InBhaW50LW9yZGVyOm1hcmtlcnMgZmlsbCBzdHJva2UiLz48cGF0aCBkPSJtOTQuMiA3My45MjYtMi4zODIgNC40NTg5IDExLjg4MyA2LjU2NjUtMS42MDIzIDIuOTk5My0xMS44ODMtNi41NjY1LTIuMzUgNC4zOTktMi4zODA1LTEuMzE1NSA2LjMzNDQtMTEuODU3eiIgc3R5bGU9InBhaW50LW9yZGVyOm1hcmtlcnMgZmlsbCBzdHJva2UiLz48cGF0aCBkPSJtMTA3LjgxIDcwLjEzLTIuODA5MyA1LjI1ODggMi40MDQ4IDIuNjIzOC0xLjcwMzggMy4xODkzLTExLjM2OS0xMy4zMDEgMS40ODQ4LTIuNzc5NCAxNy4xNzQgMi40MzMzLTEuNzAzOCAzLjE4OTN6bS00Ljc1NzIgMy4xMzM1IDEuOTQ0MS0zLjYzOTEtNi4zMTY0LTEuMTIwOHoiIHN0eWxlPSJwYWludC1vcmRlcjptYXJrZXJzIGZpbGwgc3Ryb2tlIi8+PC9nPjwvZz48L3N2Zz4K
// @description  Import faction walls to YATA
// @supportURL   https://www.torn.com/messages.php?p=compose&XID=1934501
// @updateURL    about:blank
// @author       Helcostr [1934501]
// @run-at       document-end
// @match        https://www.torn.com/war.php?step=warreport*
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @connect      yata.yt
// @updateURL    https://github.com/Kivou-2000607/yata/raw/master/yata/static/yata/js/userscripts/walls.user.js
// @downloadURL  https://github.com/Kivou-2000607/yata/raw/master/yata/static/yata/js/userscripts/walls.user.js
// @require      https://yata.yt/static/yata/js/userscripts.js
// @resource     YATA_CSS https://yata.yt/static/yata/css/userscripts.css
// ==/UserScript==

const cssTxt = GM_getResourceText("YATA_CSS");
GM_addStyle(cssTxt);

(() => {
  "use strict";
  if (typeof $ !== "function") {
      alert("JQuery Missing. This is a critical error.");
      return;
  }

  // Startup function
  function startup() {
      //Set up buttons
      function buttonSetup(text,cb) {
          let button = $("<button class='YATA-button'>");
          button.text(text);
          button.click(cb);
          $("#YATA-message-buttons").append(button);
      }

      //show info box
      $(".content-title").after(infobox);
      //Set up buttons
      buttonSetup("Export To YATA", sendJSON);
      buttonSetup("API Storage", () => errorKey("", true));
  }

  // Generate Report
  function genReport() {
      const report = []; //Prepare 2D array
      const focus = $(".enemy-faction,.your-faction"); //Grab both tables

      //Clone logic for result determination
      const resText = $(".faction-war-info").find("span.t-block > .text > a").parent().text();
      let result;
      if (resText.search("failed") !== -1 || resText.search("truce") !== -1)
          result = false;
      else if (resText.search("claimed") !== -1)
          result = true;

      //Header row
      const row = [];
      focus.first().find("div > div > div:not(.clear,.short)").each((i, e) => {
          const focus = $(e).text();
          if (focus === "Members") {
              row.push("Position");
              row.push("Name");
              row.push("XID");
          } else row.push(focus);
      });
      report.push(row);

      //For Each Table (Both the att and def table)
      focus.each((i,f) => {
          //For each Player
          $(f).find("div > ul.members-list > li").each((i, e) => {
              const row = [];
              row.push($(f).hasClass("your-faction") === result ? "Attacker" : "Defender"); //Determine if the user is att or def

              $(e).find("div:not(.clear)").each((i,e) => {
                  let focus = $(e);

                  if (focus.hasClass("member")) {//Player info (name, xid)
                      focus = focus.find("a.name");
                      const name = focus.data("placeholder");

                      if (typeof name === "undefined") { //Parser for plaintext
                          row.push(focus.text());
                          row.push(parseInt(/XID=(\d+)/.exec(focus.attr("href"))[1]));
                      } else { //Parser for honor bar
                          let reg = /(\S+)\s\[(\d+)\]/.exec(name);
                          row.push(`="${reg[1]}"`);
                          row.push(parseInt(reg[2]));
                      }
                  } else //All other data (should be numbers)
                      row.push(parseInt(focus.text().replace(/\D/g,'')));
              });
              report.push(row);
          });
      });
      return report;
  }

  function createJSON() {
      const gen = genReport();
      const head = gen.shift();
      const focus = $(".faction-war-info");
      const links = focus.find("span.t-block > .text > a");
      const lazy = "(\\d{2})-(\\d{2})-(\\d{4}) (\\d{2}):(\\d{2}):(\\d{2})";
      const ts = (new RegExp(lazy+" to "+lazy)).exec(focus.find("span.t-block:eq(1)").text().trim());
      const resText = links.parent().text();
      let result;
      if (resText.search("failed") !== -1) result = -1;
      else if (resText.search("claimed") !== -1) result = 1;
      else if (resText.search("truce") !== -1) result = 0;
      const report = {
          author: parseInt(getCookie("uid")),
          id: parseInt(/(\d+)/.exec($(".title-black").text())[1]),
          att_fac: parseInt(/ID=(\d+)/.exec(links.eq(0).attr("href"))[1]),
          att_fac_name: links.eq(0).text(),
          def_fac: parseInt(/ID=(\d+)/.exec(links.eq(1).attr("href"))[1]),
          def_fac_name: links.eq(1).text(),
          result: result,
          terr: links.eq(2).text(),
          ts_start: Date.UTC(ts[3], ts[1]-1, ts[2], ts[4], ts[5], ts[6]) / 1000,
          ts_end: Date.UTC(ts[3+6], ts[1+6]-1, ts[2+6], ts[4+6], ts[5+6], ts[6+6]) / 1000,
          participants: gen.map(e => {
              const obj = {};
              head.forEach((f,i)=>{
                  obj[f] = e[i];
              });
              return obj;
          })
      };
      return report;
  }

  // Send to server
  function sendJSON() {
      msgbox();
      const report = createJSON();
      const key = GM_getValue("key","");
      GM_xmlhttpRequest({
          method: "POST",
          url: "https://yata.yt/api/v1/faction/walls/import/",
          data: JSON.stringify(report),
          headers: { "key": key },
          onload: resp => {
              try {
                  const obj = JSON.parse(resp.responseText);
                  console.log(resp.status);
                  console.log(obj);
                  if (resp.status === 400) {
                      if (obj.error.code === 4) error(`API error (${obj.error.error})`);
                      else error(`User error (${obj.error.error})`);
				  }
				  else if (resp.status === 500) error("Server error (" + obj.error.error + ")");
                  else if (resp.status === 200) valid(obj.message);
                  else error("No message received from the server");
              } catch (e) {
                  error("Failed to parse response from server" + e);
              }
          },
          ontimeout: () => {
              error("Request has timed out");
          },
          onerror: () => {
              error("Unknown error has occured when trying to send the data");
          },
          onabort: () => {
              error("Upon sending the data, the request was canceled");
          }
      });
  }
  startup();
})();
